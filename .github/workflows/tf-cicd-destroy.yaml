name: "Destroy"

on: 
  workflow_call:
    inputs: 
      aws-region:
        description: 'Specifies the AWS Region.'
        required: true
        type: string
        required: true
      devl-aws-role-arn:
        description: 'Specifies the AWS IAM Role arn in development environment.'
        required: true
        type: string
      devl-kms-key-arn:
        description: 'Specifies the AWS KMS Key arn in development environment.'
        required: true
        type: string
      devl-aws-tf-state-bucket-name:
        description: 'Specifies the AWS Terraform state S3 bucket name in development environment.'
        required: true
        type: string
      test-aws-role-arn:
        description: 'Specifies the AWS IAM Role arn in test environment.'
        required: true
        type: string
      test-kms-key-arn:
        description: 'Specifies the AWS KMS Key arn in test environment.'
        required: true
        type: string
      test-aws-tf-state-bucket-name:
        description: 'Specifies the AWS Terraform state S3 bucket name in test environment.'
        required: true
        type: string
      prod-aws-role-arn:
        description: 'Specifies the AWS IAM Role arn in production environment.'
        required: true
        type: string
      prod-kms-key-arn:
        description: 'Specifies the AWS KMS Key arn in production environment.'
        required: true
        type: string
      prod-aws-tf-state-bucket-name:
        description: 'Specifies the AWS Terraform state S3 bucket name in production environment.'
        required: true
        type: string
permissions:
  id-token: write # This is required for aws oidc connection
  contents: read # This is required for actions/checkout
  pull-requests: write # This is required for gh bot to comment PR  

jobs:
  _1-devl:
    name: "Terraform Destroy (devl)"
    uses: ./.github/workflows/tf-destroy.yaml
    with:
      github-env: devl
      # tfvar-file: devl.terraform.tfvars
    # secrets:
      aws-region: ${{ vars.AWS_REGION }}
      aws-role-arn: ${{ vars.DEVL_AWS_ROLE_ARN }}
      kms-key-arn: ${{ vars.DEVL_AWS_KMS_KEY_ARN }}
      aws-tf-state-bucket-name: ${{ vars.DEVL_AWS_TF_STATE_BUCKET_NAME }}
  _2-test:
    name: "Terraform Destroy (test)"
    needs: [ _1-devl ]
    uses: ./.github/workflows/tf-destroy.yaml
    with:
      github-env: test
      # tfvar-file: test.terraform.tfvars
    # secrets:
      aws-region: ${{ vars.AWS_REGION }}
      aws-role-arn: ${{ vars.TEST_AWS_ROLE_ARN }}
      kms-key-arn: ${{ vars.TEST_AWS_KMS_KEY_ARN }}
      aws-tf-state-bucket-name: ${{ vars.TEST_AWS_TF_STATE_BUCKET_NAME }}
  _3-prod:
    name: "Terraform Destroy (prod)"
    needs: [ _2-test ]
    uses: ./.github/workflows/tf-destroy.yaml
    with:
      github-env: prod
      # tfvar-file: prod.terraform.tfvars
    # secrets:
      aws-region: ${{ vars.AWS_REGION }}
      aws-role-arn: ${{ vars.PROD_AWS_ROLE_ARN }}
      kms-key-arn: ${{ vars.PROD_AWS_KMS_KEY_ARN }}
      aws-tf-state-bucket-name: ${{ vars.PROD_AWS_TF_STATE_BUCKET_NAME }}